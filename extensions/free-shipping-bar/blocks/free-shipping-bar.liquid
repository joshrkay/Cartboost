{% comment %}
  CartBoost Free Shipping Bar - Final Version with Real Tracking
  getcartboost.com

  Note: Plan prices in the schema labels below must be manually synced
  with PLAN_PRICES in app/shopify.server.ts (Liquid schema is static JSON).
{% endcomment %}

<div
  class="cartboost-free-shipping-bar"
  id="cartboost-bar"
  data-cartboost-experiment="free-shipping-bar"
  style="position: fixed; top: 0; left: 0; width: 100%; background: {{ block.settings.bar_background_color }}; color: white; text-align: center; padding: 14px 20px; font-size: 15px; z-index: 999999; box-shadow: 0 4px 12px rgba(0,0,0,0.25);">
  <span id="cartboost-message">Add ${{ block.settings.threshold | default: 50 }} more for free shipping!</span>
</div>

<script>
  // Safe JS defaults - use JSON filter to escape apostrophes and special chars
  const defaultBelow = 'Add X more for free shipping!';
  const defaultUnlocked = "You\u2019ve unlocked free shipping!";
  let messageBelow = {{ block.settings.below_message | json }} || defaultBelow;
  let messageUnlocked = {{ block.settings.above_message | json }} || defaultUnlocked;

  // Tracks the selected variant ID for use in subsequent events
  let activeVariantId = null;

  function initCartBoostBar() {
    const tier = {{ block.settings.tier | default: "free" | json }};
    const numVariants = parseInt({{ block.settings.num_variants | default: "2" | json }});
    const testMode = {{ block.settings.ab_test_mode | default: "same_message" | json }};
    let bgColor = {{ block.settings.bar_background_color | json }};

    if (tier !== 'free') {
      let activeColors = [];
      let activeBelow = [];
      let activeUnlocked = [];

      if (tier === 'pro') {
        activeColors = [
          {{ block.settings.variant_a | json }},
          {{ block.settings.variant_b | json }},
          {{ block.settings.variant_c | json }}
        ].slice(0, numVariants);
      } else if (tier === 'premium') {
        activeColors = [
          {{ block.settings.variant_a | json }},
          {{ block.settings.variant_b | json }},
          {{ block.settings.variant_c | json }},
          {{ block.settings.variant_d | json }},
          {{ block.settings.variant_e | json }}
        ].slice(0, numVariants);
        activeBelow = [
          {{ block.settings.variant_a_below | json }},
          {{ block.settings.variant_b_below | json }},
          {{ block.settings.variant_c_below | json }},
          {{ block.settings.variant_d_below | json }},
          {{ block.settings.variant_e_below | json }}
        ].slice(0, numVariants);
        activeUnlocked = [
          {{ block.settings.variant_a_unlocked | json }},
          {{ block.settings.variant_b_unlocked | json }},
          {{ block.settings.variant_c_unlocked | json }},
          {{ block.settings.variant_d_unlocked | json }},
          {{ block.settings.variant_e_unlocked | json }}
        ].slice(0, numVariants);
      }

      const randomIndex = Math.floor(Math.random() * numVariants);
      const variantLetter = String.fromCharCode(65 + randomIndex);

      if (testMode === 'same_message') {
        bgColor = activeColors[randomIndex];
      } else if (testMode === 'random_message_random_color') {
        bgColor = activeColors[Math.floor(Math.random() * activeColors.length)];
        messageBelow = activeBelow[Math.floor(Math.random() * activeBelow.length)] || messageBelow;
        messageUnlocked = activeUnlocked[Math.floor(Math.random() * activeUnlocked.length)] || messageUnlocked;
      } else if (testMode === 'paired') {
        bgColor = activeColors[randomIndex];
        messageBelow = activeBelow[randomIndex] || messageBelow;
        messageUnlocked = activeUnlocked[randomIndex] || messageUnlocked;
      }

      document.getElementById('cartboost-bar').style.background = bgColor;
      document.getElementById('cartboost-bar').setAttribute('data-cartboost-variant', variantLetter);

      // Fetch real variant IDs from the server, then send impression
      fetch('/apps/cartboost/api/variants')
        .then(function(r) { return r.json(); })
        .then(function(data) {
          var variants = data.variants || [];
          var matched = variants.find(function(v) { return v.name === variantLetter; });
          if (matched) {
            activeVariantId = matched.id;
            sendEvent('impression', activeVariantId);
          }
        })
        .catch(function() {});
    } else {
      // Free tier — fetch variants and use the first one (A) for tracking
      fetch('/apps/cartboost/api/variants')
        .then(function(r) { return r.json(); })
        .then(function(data) {
          var variants = data.variants || [];
          if (variants.length > 0) {
            activeVariantId = variants[0].id;
            sendEvent('impression', activeVariantId);
          }
        })
        .catch(function() {});
    }

    updateCartBoostMessage();
  }

  function sendEvent(eventType, variantId) {
    if (!variantId) return;
    fetch('/apps/cartboost/api/track-event', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        variantId: variantId,
        eventType: eventType,
      }),
    }).catch(function() {});
  }

  function updateCartBoostMessage() {
    fetch('/cart.js', { cache: 'default' })
      .then(function(r) { return r.json(); })
      .then(function(cart) {
        const subtotal = cart.total_price / 100;
        const threshold = {{ block.settings.threshold | default: 50 }};
        const msgEl = document.getElementById('cartboost-message');
        if (subtotal >= threshold) {
          msgEl.textContent = messageUnlocked;
        } else {
          const remaining = (threshold - subtotal).toFixed(2);
          msgEl.textContent = messageBelow.replace('X', remaining);
        }
      });
  }

  // Push page content down so it's not hidden behind the fixed bar
  function adjustBodyOffset() {
    var bar = document.getElementById('cartboost-bar');
    if (bar) {
      document.body.style.marginTop = bar.offsetHeight + 'px';
    }
  }

  // Cart change detection: Shopify themes use fetch() or XHR to update the cart via
  // /cart/add|change|update|clear.js endpoints. We intercept these calls to detect
  // cart updates and refresh the shipping bar message. This approach is necessary because
  // not all themes fire custom JavaScript events for cart changes. The original fetch/XHR
  // functions are preserved and called normally — we only add a post-response handler.
  var cartUrlPattern = /\/cart\/(add|change|update|clear)\.js/;

  var originalFetch = window.fetch;
  window.fetch = function() {
    var url = typeof arguments[0] === 'string' ? arguments[0] : (arguments[0] && arguments[0].url) || '';
    var result = originalFetch.apply(this, arguments);
    if (cartUrlPattern.test(url)) {
      result.then(function() { updateCartBoostMessage(); });
    }
    return result;
  };

  var originalXHROpen = XMLHttpRequest.prototype.open;
  var originalXHRSend = XMLHttpRequest.prototype.send;
  XMLHttpRequest.prototype.open = function(method, url) {
    this._cartboostUrl = url;
    return originalXHROpen.apply(this, arguments);
  };
  XMLHttpRequest.prototype.send = function() {
    if (cartUrlPattern.test(this._cartboostUrl || '')) {
      this.addEventListener('load', function() { updateCartBoostMessage(); });
    }
    return originalXHRSend.apply(this, arguments);
  };

  document.addEventListener('DOMContentLoaded', function() {
    initCartBoostBar();
    adjustBodyOffset();
  });
  window.addEventListener('resize', adjustBodyOffset);

  // Keep theme-specific event listeners as a bonus for themes that support them
  document.addEventListener('cart:updated', updateCartBoostMessage);
  document.addEventListener('cart:change', updateCartBoostMessage);
  document.addEventListener('cart:refresh', updateCartBoostMessage);
</script>

{% schema %}
{
  "name": "CB Free Shipping Bar",
  "target": "section",
  "settings": [
    {
      "type": "select",
      "id": "tier",
      "label": "Upgrade Level",
      "options": [
        { "value": "free", "label": "Free (Basic)" },
        { "value": "pro", "label": "Pro ($7.99/mo)" },
        { "value": "premium", "label": "Premium ($10.99/mo)" }
      ],
      "default": "free"
    },
    {
      "type": "number",
      "id": "threshold",
      "label": "Free Shipping Threshold ($)",
      "default": 50
    },
    {
      "type": "color",
      "id": "bar_background_color",
      "label": "Bar background color (Free tier)",
      "default": "#222222"
    },
    {
      "type": "textarea",
      "id": "below_message",
      "label": "Below threshold message (shared in Pro)",
      "default": "Add X more for free shipping!"
    },
    {
      "type": "textarea",
      "id": "above_message",
      "label": "Unlocked message (shared in Pro)",
      "default": "You've unlocked free shipping!"
    },
    {
      "type": "select",
      "id": "ab_test_mode",
      "label": "A/B Test Mode (Premium only)",
      "options": [
        { "value": "same_message", "label": "Same message, different colors" },
        { "value": "random_message_random_color", "label": "Random message + random color" },
        { "value": "paired", "label": "Paired message + color per variant" }
      ],
      "default": "same_message"
    },
    {
      "type": "select",
      "id": "num_variants",
      "label": "Number of variants",
      "options": [
        { "value": "2", "label": "2 variants (A/B)" },
        { "value": "3", "label": "3 variants (A/B/C)" },
        { "value": "4", "label": "4 variants (A/B/C/D)" },
        { "value": "5", "label": "5 variants (A/B/C/D/E)" }
      ],
      "default": "2"
    },
    { "type": "color", "id": "variant_a", "label": "Variant A background color", "default": "#1a1a1a" },
    { "type": "color", "id": "variant_b", "label": "Variant B background color", "default": "#2c2c2c" },
    { "type": "color", "id": "variant_c", "label": "Variant C background color", "default": "#3a3a3a" },
    { "type": "color", "id": "variant_d", "label": "Variant D background color", "default": "#4a4a4a" },
    { "type": "color", "id": "variant_e", "label": "Variant E background color", "default": "#5a5a5a" },
    { "type": "textarea", "id": "variant_a_below", "label": "Variant A below threshold message (Premium only)", "default": "Add X more for free shipping!" },
    { "type": "textarea", "id": "variant_a_unlocked", "label": "Variant A unlocked message (Premium only)", "default": "You've unlocked free shipping!" },
    { "type": "textarea", "id": "variant_b_below", "label": "Variant B below threshold message (Premium only)", "default": "Only X away from free shipping!" },
    { "type": "textarea", "id": "variant_b_unlocked", "label": "Variant B unlocked message (Premium only)", "default": "Free shipping unlocked!" },
    { "type": "textarea", "id": "variant_c_below", "label": "Variant C below threshold message (Premium only)", "default": "Add X more for free shipping!" },
    { "type": "textarea", "id": "variant_c_unlocked", "label": "Variant C unlocked message (Premium only)", "default": "You've unlocked free shipping!" },
    { "type": "textarea", "id": "variant_d_below", "label": "Variant D below threshold message (Premium only)", "default": "Add X more for free shipping!" },
    { "type": "textarea", "id": "variant_d_unlocked", "label": "Variant D unlocked message (Premium only)", "default": "You've unlocked free shipping!" },
    { "type": "textarea", "id": "variant_e_below", "label": "Variant E below threshold message (Premium only)", "default": "Add X more for free shipping!" },
    { "type": "textarea", "id": "variant_e_unlocked", "label": "Variant E unlocked message (Premium only)", "default": "You've unlocked free shipping!" }
  ]
}
{% endschema %}
